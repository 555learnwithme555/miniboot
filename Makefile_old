# Author: Mihai Galos
# Creation Date: 2018-01-11
# Makefile Based on: https://gist.github.com/C222/5755c5a5a323de2e88b9
# License: GNU GPL v2 (see License.txt)


# Hey Emacs, this is a -*- makefile -*-
# C222
# June 2013

# Target file name
TARGET = miniboot
# Which chip to program for
MCU = atmega328p
FRQ = 8000000
BOOTLOADER_START_ADDRESS = 0x6800

# List of C source files and object files
SRC =	$(TARGET).c \
	I2C-master-lib/i2c_master.c 
OBJ = $(SRC:.c=.o)
  
# Executable names
COMPILER = avr-g++
COPY = avr-objcopy
DFU = dfu-programmer
ALL_CFLAGS = -I. -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics -MMD -flto -mmcu=$(MCU) -DF_CPU=$(FRQ)UL
LDFLAGS = -Wl,--relax,--section-start=.text=$(BOOTLOADER_START_ADDRESS),--gc-sections,-Map=$(TARGET).map

# Misc arguments

version:
	@echo =====Version=====
	@$(COMPILER) --version
	@echo


bootloader.h:
	@echo =====Header Generation=====
	@echo "// Automatically generated by Makefile. DO NOT EDIT!" > $@
	@echo -en '\n' >> $@
	@echo "#pragma once" >> $@
	@echo -en '\n' >> $@
	@echo "#define BOOTLOADER_START_ADDRESS $(BOOTLOADER_START_ADDRESS)" >> $@
	@echo

build: version bootloader.h elf
	#$(COMPILER) -mmcu=$(CHIP) $(DEFS) -O$(OPT) $(LIBS) -std=$(STD) $(SRC) -o $(TARGET).elf $(LDFLAGS)
	@echo
	@echo =====Making .hex File=====
	$(COPY) -O ihex -R .eeprom -R .fuse -R .lock -R .signature $(TARGET).elf $(TARGET).hex
	@echo =====Done=====
	@echo

build-pedantic: version bootloader.h
	#$(COMPILER) -mmcu=$(CHIP) $(DEFS) -O$(OPT) $(LIBS) -std=$(STD) --pedantic  $(SRC) -o $(TARGET).elf $(LDFLAGS)
	@echo
	@echo =====Making .hex File=====
	$(COPY) -O ihex -R .eeprom -R .fuse -R .lock -R .signature $(TARGET).elf $(TARGET).hex
	@echo
	@echo =====Pedantic Build Done=====
	@echo
	@echo

info:
	@echo Size of binary hexfile. Use the "data" size to calculate the bootloader address:
	@avr-size $(TARGET).hex
	@echo
	@echo Memory map written to $(TARGET).map
clean:
	@echo =====Cleaning=====
	rm -f $(TARGET).elf $(TARGET).hex $(TARGET).map bootloader.h
	@echo

# Compile: create object files from C source files.
elf: $(TARGET).elf
%.o : %.c
	@echo =====Compiling=====
	@echo
	@echo Compiling: $<
	$(COMPILER) -c $(ALL_CFLAGS) $< -o $@
%.elf: $(OBJ)
	@echo
	@echo Linking $@
	$(COMPILER) $(LDFLAGS) $(OBJ) --output $@   


rebuild: clean build info
rebuild-pedantic: clean build-pedantic
default: build info
all: build info


